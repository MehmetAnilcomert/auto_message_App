<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhatsApp Admin Panel</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 40px;
        max-width: 500px;
        width: 100%;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        animation: slideUp 0.6s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h1 {
        color: white;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 30px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      h2 {
        color: white;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 30px 0 20px 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .status {
        padding: 16px 24px;
        border-radius: 12px;
        margin: 24px 0;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .pending {
        background: rgba(255, 193, 7, 0.2);
        color: #fff3cd;
        border: 1px solid rgba(255, 193, 7, 0.3);
      }

      .ready {
        background: rgba(40, 167, 69, 0.2);
        color: #d4edda;
        border: 1px solid rgba(40, 167, 69, 0.3);
      }

      .failed {
        background: rgba(220, 53, 69, 0.2);
        color: #f8d7da;
        border: 1px solid rgba(220, 53, 69, 0.3);
      }

      /* Added modern form styling */
      .form-container {
        margin-top: 30px;
        text-align: left;
      }

      .form-group {
        margin-bottom: 20px;
      }

      input,
      textarea {
        width: 100%;
        padding: 14px 18px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(255, 255, 255, 0.7);
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: rgba(37, 211, 102, 0.5);
        box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2);
        background: rgba(255, 255, 255, 0.15);
      }

      textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
      }

      .qr-link {
        display: inline-block;
        color: #25d366;
        text-decoration: none;
        font-weight: 600;
        padding: 12px 24px;
        border: 2px solid rgba(37, 211, 102, 0.3);
        border-radius: 12px;
        background: rgba(37, 211, 102, 0.1);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        margin: 20px 0;
      }

      .qr-link:hover {
        background: rgba(37, 211, 102, 0.2);
        border-color: rgba(37, 211, 102, 0.5);
        transform: translateY(-2px);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      button {
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        backdrop-filter: blur(10px);
        width: 100%;
        margin-top: 10px;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Added result message styling */
      .result {
        margin: 20px 0;
        padding: 16px 20px;
        border-radius: 12px;
        font-weight: 600;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .result.success {
        background: rgba(40, 167, 69, 0.2);
        color: #d4edda;
        border: 1px solid rgba(40, 167, 69, 0.3);
      }

      .result.error {
        background: rgba(220, 53, 69, 0.2);
        color: #f8d7da;
        border: 1px solid rgba(220, 53, 69, 0.3);
      }

      .info-text {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        margin-top: 15px;
        line-height: 1.5;
      }

      @media (max-width: 480px) {
        .container {
          padding: 30px 20px;
          margin: 10px;
        }

        h1 {
          font-size: 1.6rem;
        }

        h2 {
          font-size: 1.3rem;
        }

        input,
        textarea,
        button {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“± WhatsApp Admin Panel</h1>

      <div id="status" class="status pending">
        <div class="loading-spinner"></div>
        Durum: YÃ¼kleniyor...
      </div>

      <div id="form-container" class="form-container">
        <!-- Form content will be loaded here -->
      </div>
    </div>

    <script>
      const statusTexts = {
        pending: "â³ BaÅŸlatÄ±lÄ±yor...",
        qr_generated: "ğŸ“± QR kodu oluÅŸturuldu",
        authenticating: "ğŸ” Kimlik doÄŸrulanÄ±yor...",
        ready: "âœ… HazÄ±r!",
        failed: "âŒ BaÄŸlantÄ± baÅŸarÄ±sÄ±z",
      };

      function getStatusText(status) {
        return statusTexts[status] || status;
      }

      let lastAuthStatus = null;
      let lastReady = null;

      async function fetchStatus() {
        try {
          const res = await fetch("/whatsapp-status");
          if (!res.ok) throw new Error("API yanÄ±t vermedi");

          const status = await res.json();
          console.log("[v1] Status data:", status);

          const statusDiv = document.getElementById("status");
          const formContainer = document.getElementById("form-container");

          // ğŸ”¹ Sadece deÄŸiÅŸiklik varsa DOM gÃ¼ncelleniyor
          if (
            status.authStatus !== lastAuthStatus ||
            status.ready !== lastReady
          ) {
            statusDiv.className =
              "status " +
              (status.ready
                ? "ready"
                : status.authStatus === "failed"
                ? "failed"
                : "pending");
            statusDiv.innerHTML =
              "<strong>Durum:</strong> " + getStatusText(status.authStatus);

            if (status.ready) {
              // Form sadece bir kez ekleniyor
              if (!formContainer.querySelector("#messageForm")) {
                formContainer.innerHTML = `
              <h2>ğŸ“¤ Mesaj GÃ¶nder</h2>
              <form id="messageForm">
                <div class="form-group">
                  <input type="text" id="firstName" placeholder="Ad" required>
                </div>
                <div class="form-group">
                  <input type="text" id="lastName" placeholder="Soyad" required>
                </div>
                <div class="form-group">
                  <input type="tel" id="phone" placeholder="Telefon (5551234567)" required>
                </div>
                <div class="form-group">
                  <textarea id="message" placeholder="Mesaj iÃ§eriÄŸi" required></textarea>
                </div>
                <button type="submit">ğŸ“¤ Mesaj GÃ¶nder</button>
              </form>
              <div id="result"></div>
            `;
                attachFormHandler();
              }
            } else {
              formContainer.innerHTML = `
            <div class="info-text">
              WhatsApp baÄŸlantÄ±sÄ± kurulmadÄ±
            </div>
            <a href="/qr" class="qr-link">ğŸ”— QR kod sayfasÄ±na git</a>
          `;
            }
          }

          lastAuthStatus = status.authStatus;
          lastReady = status.ready;
        } catch (error) {
          console.error("[v1] Fetch error:", error);
          document.getElementById("status").innerHTML =
            "<strong>Durum:</strong> âŒ BaÄŸlantÄ± hatasÄ±";
          document.getElementById("form-container").innerHTML = `
        <div class="info-text">
          ğŸ”Œ Sunucuya baÄŸlanÄ±lamÄ±yor<br>
          <small>LÃ¼tfen sayfayÄ± yenileyin</small>
        </div>
      `;
        }
      }

      function attachFormHandler() {
        const form = document.getElementById("messageForm");
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const person = {
            first_name: document.getElementById("firstName").value,
            last_name: document.getElementById("lastName").value,
            phone_number: document.getElementById("phone").value,
            custom_message: document.getElementById("message").value,
          };

          const result = document.getElementById("result");
          const submitBtn = form.querySelector('button[type="submit"]');

          submitBtn.disabled = true;
          submitBtn.innerHTML = "â³ GÃ¶nderiliyor...";
          result.innerHTML =
            '<div class="result"><div class="loading-spinner"></div>Mesaj gÃ¶nderiliyor...</div>';

          try {
            const response = await fetch("/send-birthday-message", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ person }),
            });
            const data = await response.json();

            result.className = "result " + (data.success ? "success" : "error");
            result.innerHTML = data.success
              ? "âœ… Mesaj baÅŸarÄ±yla gÃ¶nderildi!"
              : "âŒ Hata: " + (data.error || "Bilinmeyen hata");

            if (data.success) {
              form.reset();
            }
          } catch (error) {
            result.className = "result error";
            result.innerHTML = "âŒ BaÄŸlantÄ± hatasÄ±: " + error.message;
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = "ğŸ“¤ Mesaj GÃ¶nder";
          }
        });
      }

      // BaÅŸlat
      fetchStatus();
      setInterval(fetchStatus, 5000);
    </script>
  </body>
</html>
